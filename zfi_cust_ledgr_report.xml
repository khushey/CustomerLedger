*&---------------------------------------------------------------------*
*& Report ZKBPROG1
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT ZFI_CUST_LEDGER.

TABLES: BSEG.

SELECT-OPTIONS: E_BUDAT FOR BSEG-H_BUDAT.

PARAMETERS: E_KUNNR TYPE BSEG-KUNNR,
            E_BUKRS TYPE BSEG-BUKRS.


TYPES: BEGIN OF INVOICE_DTYP,

         H_BUDAT TYPE BSEG-H_BUDAT, "Posting date
         BELNR   TYPE BSEG-BELNR, "Invoice Number
         AUGBL   TYPE BSEG-AUGBL, "Receipt Number
         VBELN   TYPE BSEG-VBELN, "Order/Batch Number
         SGTXT   TYPE BSEG-SGTXT, "Reference
         SHKZG   TYPE BSEG-SHKZG, "Debit/credit indicator
         DMBTR   TYPE BSEG-DMBTR, "debit/credit amount

       END OF INVOICE_DTYP.


DATA: ADDRESS     TYPE ZCUST_DET,
      INVOICE     TYPE TABLE OF INVOICE_DTYP,
      WA_INVOICE  TYPE INVOICE_DTYP,
      INVOICE1    TYPE ZINVOICE_DTYP,
      WA_INVOICE1 LIKE LINE OF INVOICE1,
      BAL         TYPE DMBTR,
      SEL_DAT     TYPE BSEG-H_BUDAT.

SEL_DAT = E_BUDAT-LOW - 1.

DATA: FORM_NAME TYPE RS38L_FNAM.

SELECT SINGLE NAME1
  FROM KNA1
  INTO CORRESPONDING FIELDS OF ADDRESS
  WHERE KUNNR = E_KUNNR.

SELECT SINGLE ADDRNUMBER
  FROM BUT020
  INTO CORRESPONDING FIELDS OF ADDRESS
  WHERE PARTNER = E_KUNNR.

SELECT SINGLE HOUSE_NUM1 STREET CITY1 TEL_NUMBER
  FROM ADRC
  INTO CORRESPONDING FIELDS OF ADDRESS
  WHERE ADDRNUMBER = ADDRESS-ADDRNUMBER.

SELECT SINGLE ZTERM
  FROM KNVV
  INTO CORRESPONDING FIELDS OF ADDRESS
  WHERE KUNNR = E_KUNNR.

SELECT SINGLE VTEXT
  FROM TVZBT
  INTO CORRESPONDING FIELDS OF ADDRESS
  WHERE ZTERM = ADDRESS-ZTERM.

SELECT *
  FROM BSEG
  INTO CORRESPONDING FIELDS OF TABLE INVOICE
  WHERE KUNNR = E_KUNNR
  AND BUKRS = E_BUKRS
  AND H_BUDAT IN E_BUDAT
  AND KOART = 'D'.

SORT INVOICE BY H_BUDAT ASCENDING.

DATA FAEDT TYPE RFPOS-FAEDT.

DATA:
  LD_RETURN     TYPE BAPIRETURN,
  IT_KEYBALANCE TYPE STANDARD TABLE OF BAPI3007_3,
  WA_KEYBALANCE LIKE LINE OF IT_KEYBALANCE.

CALL FUNCTION 'BAPI_AR_ACC_GETKEYDATEBALANCE'
  EXPORTING
    COMPANYCODE = E_BUKRS
    CUSTOMER    = E_KUNNR
    KEYDATE     = SEL_DAT "Selection Date-1
  TABLES
    KEYBALANCE  = IT_KEYBALANCE.

READ TABLE IT_KEYBALANCE INTO WA_KEYBALANCE INDEX 1.
BAL = WA_KEYBALANCE-T_CURR_BAL.

LOOP AT INVOICE INTO WA_INVOICE.

  WA_INVOICE1-DATE = WA_INVOICE-H_BUDAT.
  WA_INVOICE1-INVC_NO = WA_INVOICE-BELNR.
  WA_INVOICE1-RCPT_NO = WA_INVOICE-AUGBL.
  WA_INVOICE1-BTCH_NO = WA_INVOICE-VBELN.
  WA_INVOICE1-REF_NO = WA_INVOICE-SGTXT.

  CALL FUNCTION 'NET_DUE_DATE_GET'
    EXPORTING
      I_ZFBDT = WA_INVOICE-H_BUDAT
      I_ZBD1T = 0
      I_ZBD2T = 0
      I_ZBD3T = 0
      I_SHKZG = WA_INVOICE-SHKZG
      I_REBZG = WA_INVOICE-BELNR
    IMPORTING
      E_FAEDT = FAEDT.

  WA_INVOICE1-DUE_DAT = FAEDT.

  IF WA_INVOICE-SHKZG EQ 'S'.
    WA_INVOICE1-DBT = WA_INVOICE-DMBTR.
    CLEAR WA_INVOICE1-CRDT.
  ELSEIF WA_INVOICE-SHKZG EQ 'H'.
    WA_INVOICE1-CRDT = WA_INVOICE-DMBTR.
    CLEAR WA_INVOICE1-DBT.
  ENDIF.

  IF SY-TABIX EQ 1.

    WA_INVOICE1-BLNCE = WA_KEYBALANCE-T_CURR_BAL + WA_INVOICE1-DBT - WA_INVOICE1-CRDT.
  ELSE.
    WA_INVOICE1-BLNCE = WA_INVOICE1-BLNCE + WA_INVOICE1-DBT - WA_INVOICE1-CRDT.
  ENDIF.

  APPEND WA_INVOICE1 TO INVOICE1.

ENDLOOP.


CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
  EXPORTING
    FORMNAME = 'ZFI_CUST_LEDGR'
  IMPORTING
    FM_NAME  = FORM_NAME.
IF SY-SUBRC <> 0.
* Implement suitable error handling here
ENDIF.


CALL FUNCTION FORM_NAME "'/1BCDWB/SF00000127'
  EXPORTING
    I_KUNNR   = E_KUNNR
    I_BUKRS   = E_BUKRS
    I_CUST    = ADDRESS
    I_BAL     = BAL
    I_DATFROM = E_BUDAT-LOW
    I_DATETO  = E_BUDAT-HIGH
  TABLES
    I_INVOICE = INVOICE1.
IF SY-SUBRC <> 0.
* Implement suitable error handling here
ENDIF.
